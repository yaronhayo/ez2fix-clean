---
import { siteConfig } from '@/config/site';
import BookingFormClean from '@/components/ui/BookingFormClean.astro';
import Card from '@/components/ui/Card.astro';
import CTA from '@/components/ui/CTA.astro';
---

<section class="relative hero-responsive overflow-hidden hero-section">
  <!-- Optimized static background for LCP - video loads after interaction -->
  <div class="absolute inset-0 w-full h-full hero-background"></div>

  <!-- Video loads after user interaction to improve LCP -->
  <video
    muted
    loop
    playsinline
    preload="none"
    class="absolute inset-0 w-full h-full object-cover hero-video opacity-0 transition-opacity duration-500"
    id="heroVideo"
    style="display: none;"
  >
    <source data-src="https://qjvikxuhqs1py0go.public.blob.vercel-storage.com/ez2fix-hero-background.mp4" type="video/mp4">
  </video>

  <!-- Immediate background for LCP -->
  <div class="absolute inset-0 w-full h-full bg-gradient-to-br from-gray-900 via-gray-800 to-black"></div>

  <!-- Overlay -->
  <div class="absolute inset-0 bg-black bg-opacity-60"></div>

  <div class="container-responsive relative z-10">
      
      <!-- Hero Content Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-responsive items-center">
        
        <!-- Left Side - Hero Content -->
        <div class="hero-content-responsive order-2 lg:order-1">
          

          <!-- SEO-Optimized Main Headlines -->
          <h1 class="hero-title-responsive text-white mb-4 sm:mb-5 lg:mb-6 animate-on-scroll">
            <span class="text-white">Professional</span> <span class="text-ez2fix-gold">Garage Door Repair</span>
            <br />
            <span class="text-white">&</span> <span class="text-ez2fix-primary">Installation Services</span>
            <br />
            <span class="text-ez2fix-gold">in New Jersey</span>
          </h1>
          
          <!-- SEO-Optimized Subtitle with Keywords -->
          <p class="hero-subtitle-responsive text-white mb-4 sm:mb-6 lg:mb-8 animate-on-scroll">
            Professional <span class="text-ez2fix-gold font-semibold">garage door repair near me</span> and <span class="text-ez2fix-gold font-semibold">garage door installation</span> across 5 New Jersey counties.
          </p>
          
          <!-- Service Coverage -->
          <div class="text-center lg:text-left mb-6 animate-on-scroll">
            <p class="text-sm md:text-base text-ez2fix-gold mb-2">Serving Bergen • Essex • Morris • Hudson • Passaic Counties</p>
            <p class="text-sm text-ez2fix-primary">Licensed Contractor #13VH13553300 • 12,000+ Families Served</p>
          </div>

          
          <!-- CTAs -->
          <div class="cta-group-responsive mb-4 sm:mb-6 lg:mb-0 animate-on-scroll">
            <CTA 
              variant="phone"
              size="large"
              href={siteConfig.links.phone}
              text={`Call ${siteConfig.business.phone}`}
              icon="phone"
              ariaLabel={`Call Ez2Fix at ${siteConfig.business.phone}`}
              class="btn-premium shadow-premium hover-lift cta-responsive w-full sm:w-auto"
            />
            <CTA 
              variant="secondary"
              size="medium"
              href="/services"
              text="View Services"
              icon="arrow"
              ariaLabel="View all garage door services"
              class="hover-lift cta-responsive w-full sm:w-auto"
            />
          </div>


        </div>

        <!-- Right Side - Booking Form (Desktop) -->
        <div class="order-1 lg:order-2 hidden lg:block animate-on-scroll">
          <Card class="card-responsive-large shadow-premium border-2 bg-ez2fix-cream border-ez2fix-primary max-w-md mx-auto">
            <BookingFormClean variant="hero" />
            
            <!-- Form Benefits -->
            <div class="mt-4 pt-4 border-t border-ez2fix-brown/20">
              <div class="grid grid-cols-2 gap-3 text-center">
                <div>
                  <div class="text-heading-3 text-ez2fix-dark">Same Day Fix</div>
                  <div class="text-body-small text-ez2fix-brown">Professional Service</div>
                </div>
                <div>
                  <div class="text-heading-3 text-ez2fix-dark">Honest Pricing</div>
                  <div class="text-body-small text-ez2fix-brown">Price Before Work</div>
                </div>
              </div>
            </div>
          </Card>
        </div>
      </div>



      </div>
    </div>
</section>

<script>
  // Load video only after user interaction to improve LCP
  let videoLoaded = false;
  let userInteracted = false;

  function loadVideoOnInteraction() {
    if (videoLoaded || !userInteracted) return;
    videoLoaded = true;

    const video = document.getElementById('heroVideo');
    const source = video?.querySelector('source[data-src]');

    if (video && source) {
      // Load the video source
      source.src = source.dataset.src;
      video.style.display = 'block';
      video.load();

      video.addEventListener('canplaythrough', () => {
        video.play().then(() => {
          video.classList.remove('opacity-0');
          video.classList.add('opacity-100');
        }).catch(() => {
          // Video failed to play, keep static background
        });
      }, { once: true });
    }
  }

  // Track user interaction
  function handleUserInteraction() {
    if (userInteracted) return;
    userInteracted = true;

    // Load video after a delay to not block interactions
    setTimeout(loadVideoOnInteraction, 1000);

    // Remove event listeners
    ['scroll', 'click', 'touchstart', 'keydown'].forEach(event => {
      document.removeEventListener(event, handleUserInteraction);
    });
  }

  // Add interaction listeners
  ['scroll', 'click', 'touchstart', 'keydown'].forEach(event => {
    document.addEventListener(event, handleUserInteraction, {
      passive: true,
      once: true
    });
  });

  // Fallback - load video after 3 seconds if no interaction
  setTimeout(() => {
    if (!userInteracted) {
      userInteracted = true;
      loadVideoOnInteraction();
    }
  }, 3000);
</script>

<style>
  .hero-section {
    min-height: 100vh;
    min-height: 100dvh;
  }

  .hero-background {
    background: linear-gradient(135deg, rgba(29, 25, 18, 0.95) 0%, rgba(42, 36, 32, 0.9) 100%),
                url('/images/ez2fix-garage-door-repair.jpg') center/cover no-repeat;
  }

  /* Desktop optimization - better above-the-fold positioning */
  @media (min-width: 1024px) {
    .hero-section {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 6rem;
    }
  }

  @media (min-width: 1280px) {
    .hero-section {
      padding-top: 8rem;
    }
  }



  @media screen and (max-height: 600px) and (orientation: landscape) {
    .hero-section {
      min-height: auto;
      padding-top: 2rem;
      padding-bottom: 2rem;
    }
    .scroll-indicator {
      display: none;
    }
  }

  @media screen and (max-width: 480px) {
    .hero-section {
      padding-top: 2rem;
      padding-bottom: 2rem;
    }
  }

  /* Mobile-specific spacing adjustments */
  @media screen and (max-width: 1023px) {
    .hero-section {
      padding-top: 2rem;
      padding-bottom: 2rem;
    }
    
    .hero-content-responsive {
      margin-top: -2rem;
    }
  }

  @media screen and (max-width: 640px) {
    .hero-content-responsive {
      margin-top: -3rem;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .hero-video {
      display: none;
    }
    .hero-section {
      background: var(--gradient-dark);
    }
    .scroll-indicator,
    .animate-bounce,
    .animate-scroll-dot {
      animation: none;
    }
  }

  @media (min-width: 475px) {
    .xs\:text-3xl {
      font-size: 1.875rem;
      line-height: 2.25rem;
    }
  }

  /* Form positioning optimization */
  @media (min-width: 1024px) {
    .hero-section .max-w-md {
      max-width: 24rem;
    }
  }

  @media (min-width: 1280px) {
    .hero-section .max-w-md {
      max-width: 26rem;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Video optimization
    const heroVideo = document.getElementById('heroVideo');
    if (heroVideo) {
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      const isSlowConnection = connection && (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g');
      
      if (prefersReducedMotion || isSlowConnection) {
        heroVideo.style.display = 'none';
        heroVideo.closest('.hero-section').style.background = 'var(--gradient-dark)';
      } else {
        heroVideo.addEventListener('canplaythrough', function() {
          this.style.opacity = '1';
        });
        
        const playPromise = heroVideo.play();
        if (playPromise !== undefined) {
          playPromise.catch(() => {
            heroVideo.style.display = 'none';
            heroVideo.closest('.hero-section').style.background = 'var(--gradient-dark)';
          });
        }
      }
    }

    // Animate elements
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('animate-in');
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });

    // Animate hero content
    const elementsToAnimate = document.querySelectorAll('.animate-on-scroll');
    elementsToAnimate.forEach((el, index) => {
      setTimeout(() => {
        el.classList.add('animate-in');
      }, index * 100);
    });
    
    // Observe other scroll animations
    document.querySelectorAll('.animate-on-scroll').forEach(el => {
      observer.observe(el);
    });

    // Handle mobile scroll indicator
    const scrollIndicator = document.querySelector('.scroll-indicator');
    if (scrollIndicator) {
      let hasScrolled = false;
      
      const handleScroll = () => {
        if (!hasScrolled && window.scrollY > 50) {
          hasScrolled = true;
          scrollIndicator.classList.add('hidden');
          window.removeEventListener('scroll', handleScroll);
        }
      };
      
      window.addEventListener('scroll', handleScroll, { passive: true });
      
      // Also hide on touch/click
      scrollIndicator.addEventListener('click', () => {
        window.scrollTo({
          top: window.innerHeight,
          behavior: 'smooth'
        });
      });
    }
  });
</script>